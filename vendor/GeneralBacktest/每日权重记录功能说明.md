# 每日权重记录功能说明

## 功能概述

你的回测系统**已经包含**每日标的权重变化的记录功能！每次运行回测时，系统会自动记录每一天每个标的的持仓权重。

## 数据存储

回测完成后，每日权重数据存储在：
```python
bt.daily_positions  # DataFrame格式，包含三列：date, asset, weight
```

## 访问方法

我为你添加了三个便捷方法来访问和分析每日权重数据：

### 1. `get_daily_positions()` - 获取原始记录

返回包含日期、资产、权重的完整记录（长格式）。

```python
# 获取每日持仓记录
positions = bt.get_daily_positions()

# 示例输出：
#         date    asset    weight
# 0  2023-01-03  000001.SZ  0.25
# 1  2023-01-03  000002.SZ  0.30
# 2  2023-01-03  600000.SH  0.45
# 3  2023-01-04  000001.SZ  0.26
# ...
```

### 2. `get_position_matrix()` - 获取权重矩阵

返回透视表格式的权重矩阵，行为日期，列为资产，更直观。

```python
# 获取权重矩阵
position_matrix = bt.get_position_matrix()

# 示例输出：
# asset      000001.SZ  000002.SZ  600000.SH
# date
# 2023-01-03    0.25       0.30       0.45
# 2023-01-04    0.26       0.29       0.45
# 2023-01-05    0.27       0.28       0.45
# ...

# 查看某一天的权重分布
print(position_matrix.loc['2023-01-03'])

# 查看某只标的的权重变化时间序列
print(position_matrix['000001.SZ'])

# 可视化权重变化
position_matrix.plot(figsize=(12, 6), title='每日标的权重变化')
```

### 3. `get_position_changes()` - 获取权重变化量

返回每日权重的变化量，正值表示增持，负值表示减持。

```python
# 获取每日权重变化
position_changes = bt.get_position_changes()

# 示例输出：
# asset      000001.SZ  000002.SZ  600000.SH
# date
# 2023-01-03    NaN        NaN        NaN       # 第一天无变化
# 2023-01-04    0.01      -0.01       0.00      # 增持000001, 减持000002
# 2023-01-05    0.01      -0.01       0.00
# ...

# 查看某一天的调仓情况
rebalance_day = position_changes.loc['2023-01-04']
print("增持标的：")
print(rebalance_day[rebalance_day > 0])
print("\n减持标的：")
print(rebalance_day[rebalance_day < 0])
```

## 完整使用示例

```python
from GeneralBacktest import GeneralBacktest
import pandas as pd

# 初始化回测
bt = GeneralBacktest(start_date='2023-01-01', end_date='2023-12-31')

# 运行回测
results = bt.run_backtest(
    weights_data=your_weights,
    price_data=your_prices,
    buy_price='open',
    sell_price='close',
    adj_factor_col='adj_factor',
    close_price_col='close'
)

# ============ 访问每日权重 ============

# 方法1: 获取原始数据
positions = bt.get_daily_positions()
print(f"总记录数: {len(positions)}")
print(f"包含资产数: {positions['asset'].nunique()}")
print(f"时间跨度: {positions['date'].min()} 至 {positions['date'].max()}")

# 方法2: 获取权重矩阵（推荐用于分析）
position_matrix = bt.get_position_matrix()

# 查看最新持仓
print("\n最新持仓分布:")
print(position_matrix.iloc[-1].sort_values(ascending=False))

# 查看某只标的的权重走势
stock_weights = position_matrix['000001.SZ']
print(f"\n000001.SZ 权重统计:")
print(f"  平均权重: {stock_weights.mean():.2%}")
print(f"  最大权重: {stock_weights.max():.2%}")
print(f"  最小权重: {stock_weights.min():.2%}")

# 方法3: 分析权重变化
position_changes = bt.get_position_changes()

# 找出调仓日（权重有变化的日期）
rebalance_days = position_changes.abs().sum(axis=1) > 0
print(f"\n调仓次数: {rebalance_days.sum()}")

# 可视化某只标的的权重变化
import matplotlib.pyplot as plt

fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 8))

# 上图：权重时间序列
position_matrix['000001.SZ'].plot(ax=ax1, title='000001.SZ 权重走势')
ax1.set_ylabel('权重')
ax1.grid(True, alpha=0.3)

# 下图：权重变化量
position_changes['000001.SZ'].plot(ax=ax2, kind='bar', title='000001.SZ 权重变化')
ax2.set_ylabel('权重变化')
ax2.axhline(y=0, color='black', linestyle='--', linewidth=0.5)
ax2.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()
```

## 高级分析示例

### 分析持仓集中度

```python
# 计算每日的赫芬达尔指数（持仓集中度）
position_matrix = bt.get_position_matrix()
herfindahl_index = (position_matrix ** 2).sum(axis=1)

print(f"平均持仓集中度: {herfindahl_index.mean():.4f}")
print(f"最高持仓集中度: {herfindahl_index.max():.4f} (日期: {herfindahl_index.idxmax()})")

# 可视化持仓集中度趋势
herfindahl_index.plot(figsize=(12, 4), title='持仓集中度（赫芬达尔指数）')
plt.ylabel('HHI')
plt.grid(True, alpha=0.3)
plt.show()
```

### 统计调仓频率

```python
position_changes = bt.get_position_changes()

# 计算每次调仓的换手幅度
turnover_magnitude = position_changes.abs().sum(axis=1) / 2  # 单边换手
turnover_magnitude = turnover_magnitude[turnover_magnitude > 0]  # 过滤无变化日期

print(f"调仓次数: {len(turnover_magnitude)}")
print(f"平均单次换手率: {turnover_magnitude.mean():.2%}")
print(f"最大单次换手率: {turnover_magnitude.max():.2%}")

# 可视化调仓频率和幅度
turnover_magnitude.plot(kind='bar', figsize=(14, 5), title='调仓换手率')
plt.ylabel('单边换手率')
plt.xlabel('调仓日期')
plt.grid(True, alpha=0.3)
plt.show()
```

### 导出权重数据

```python
# 导出为CSV
position_matrix = bt.get_position_matrix()
position_matrix.to_csv('每日持仓权重.csv')

# 导出为Excel
with pd.ExcelWriter('回测结果.xlsx') as writer:
    position_matrix.to_excel(writer, sheet_name='每日权重')
    position_changes.to_excel(writer, sheet_name='权重变化')
    bt.get_metrics().to_excel(writer, sheet_name='性能指标')
```

## 注意事项

1. **自动记录**：运行`run_backtest()`后，系统会自动记录每日权重，无需额外配置
2. **内存占用**：对于长时间回测或大量标的，每日记录会占用一定内存
3. **权重漂移**：记录的是收盘时的实际权重（考虑价格涨跌导致的权重漂移）
4. **零权重过滤**：系统会自动过滤掉小于1e-6的微小权重，避免浮点数精度问题

## 总结

✅ **你的回测系统已经具备完整的每日权重记录功能**

我为你添加了三个便捷访问方法：
- `get_daily_positions()` - 原始长格式数据
- `get_position_matrix()` - 矩阵格式（推荐）
- `get_position_changes()` - 权重变化量

这些方法可以满足各种权重分析需求！
